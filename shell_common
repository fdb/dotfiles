# Common shell configuration for bash and zsh
# Source this file from both .bashrc and .zshrc

# Git aliases
alias gs='git status'
alias ga='git add'
alias gaa='git add --all'
alias gb='git branch'
alias gco='git checkout'
alias gc='git commit'
alias gca='git commit --amend'
alias gcm='git commit -m'
alias gl='git log --oneline --graph'
alias gd='git diff'
alias gdc='git diff --cached'
alias gf='git fetch'
alias gpush='git push'
alias gp='git pull'
alias gss='git stash'
alias gsp='git stash pop'
alias gdmb='git branch --merged | egrep -v "(^\*|master|main|dev)" | xargs git branch -d'

# Git worktree helpers
function _git_main_root() {
  local common_dir
  common_dir=$(git rev-parse --path-format=absolute --git-common-dir 2>/dev/null) || { echo "Not in a git repo" >&2; return 1; }
  echo "${common_dir%/.git}"
}

function gwt() {
  if [ -z "$1" ]; then
    git worktree list
    return
  fi
  local name="$1"
  local root
  root=$(_git_main_root) || return 1
  local wt_dir="$root/.worktrees/$name"
  if [ -d "$wt_dir" ]; then
    cd "$wt_dir"
  else
    git worktree add "$wt_dir" -b "$name" && cd "$wt_dir"
  fi
}

function gwtrm() {
  local root
  root=$(_git_main_root) || return 1

  local name="$1"
  if [ -z "$name" ]; then
    local toplevel
    toplevel=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ "$toplevel" = "$root" ]; then
      echo "Not in a worktree. Usage: gwtrm [branch-name]"
      return 1
    fi
    name=$(basename "$toplevel")
  fi

  cd "$root" && git worktree remove "$root/.worktrees/$name"
}

# Claude alias
alias ccc='claude --dangerously-skip-permissions --worktree'

# Directory navigation
alias ..="cd .."
alias ...="cd ../.."
alias duh='du -h -d 1 | sort -h'

# Rust aliases
alias cr='cargo run'
alias ct='cargo test'

# Set terminal colors
export TERM=xterm-256color

# Cheat sheet lookup
function cheat() { curl cheat.sh/$1; }

# Navigate up N directories
function up() { cd $(eval printf '../'%.0s {1..$1}); }

# macOS: Navigate to Finder window
if [[ "$OSTYPE" == darwin* ]]; then
    ff() {
        osascript -e 'tell application "Finder"' \
        -e "if (${1-1} <= (count Finder windows)) then" \
        -e "get POSIX path of (target of window ${1-1} as alias)" \
        -e 'else' -e 'get POSIX path of (desktop as alias)' \
        -e 'end if' -e 'end tell'
    }
    cdff() { cd "$(ff "$@")"; }
fi
